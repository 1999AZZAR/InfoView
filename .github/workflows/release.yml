name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        sudo mv bin/arduino-cli /usr/local/bin/
        arduino-cli version
        arduino-cli config init --overwrite
        
    - name: Install ESP32 board support
      run: |
        arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        # Install latest ESP32 platform version
        arduino-cli core install esp32:esp32
        # List installed versions for verification
        arduino-cli core list
        
    - name: Install required libraries
      run: |
        arduino-cli lib install "ChronosESP32"
        arduino-cli lib install "ESP32Time"
        arduino-cli lib install "Adafruit GFX Library"
        arduino-cli lib install "Adafruit SSD1306"
        
    - name: Compile firmware
      working-directory: ./code
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32c3:PartitionScheme=default --verbose code.ino
        echo "Build completed. Checking for output files..."
        find . -name "*.bin" -type f 2>/dev/null || true
        
    - name: Find and copy compiled binary
      working-directory: ./code
      run: |
        mkdir -p compiled
        echo "Searching for compiled binary..."
        
        # Try multiple possible locations
        POSSIBLE_DIRS=(
          "build/esp32.esp32.esp32c3"
          "build"
          "."
        )
        
        BINARY_FILE=""
        for DIR in "${POSSIBLE_DIRS[@]}"; do
          if [ -d "$DIR" ]; then
            echo "Checking directory: $DIR"
            # Look for code.ino.bin first
            FOUND=$(find "$DIR" -name "code.ino.bin" -type f 2>/dev/null | head -1)
            if [ -n "$FOUND" ]; then
              BINARY_FILE="$FOUND"
              break
            fi
            # Look for any .bin file excluding bootloader and partitions
            FOUND=$(find "$DIR" -name "*.bin" -type f 2>/dev/null | grep -v "bootloader\|partitions" | head -1)
            if [ -n "$FOUND" ]; then
              BINARY_FILE="$FOUND"
              break
            fi
          fi
        done
        
        # If still not found, get the largest .bin file
        if [ -z "$BINARY_FILE" ]; then
          echo "Trying fallback: largest .bin file"
          BINARY_FILE=$(find . -name "*.bin" -type f -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr | head -1 | awk '{print $NF}')
        fi
        
        if [ -n "$BINARY_FILE" ] && [ -f "$BINARY_FILE" ]; then
          cp "$BINARY_FILE" compiled/firmware.bin
          echo "Binary copied: $BINARY_FILE -> compiled/firmware.bin"
          ls -lh compiled/firmware.bin
          file compiled/firmware.bin
          echo "Binary size: $(du -h compiled/firmware.bin | cut -f1)"
        else
          echo "Error: Binary file not found"
          echo "Searching all .bin files:"
          find . -name "*.bin" -type f 2>/dev/null || echo "No .bin files found"
          echo "Build directory contents:"
          find . -type d -name "build" -exec ls -la {} \; 2>/dev/null || echo "No build directory found"
          exit 1
        fi
        
    - name: Create source archive
      run: |
        git archive --format=zip --output=InfoView-source.zip HEAD
        
    - name: Determine release tag
      id: release_tag
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          # Use the tag that triggered the workflow
          TAG_NAME="${{ github.ref_name }}"
          echo "Using triggered tag: $TAG_NAME"
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
            echo "Using manual input tag: $TAG_NAME"
          else
            # Get latest tag
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LATEST_TAG" ]; then
              TAG_NAME="v1.0.0"
              echo "No existing tags, using default: $TAG_NAME"
            else
              TAG_NAME="$LATEST_TAG"
              echo "Using latest tag: $TAG_NAME"
            fi
          fi
        else
          # For branch pushes, get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found. Skipping release creation."
            echo "skip_release=true" >> $GITHUB_OUTPUT
            exit 0
          else
            TAG_NAME="$LATEST_TAG"
            echo "Using latest tag for branch push: $TAG_NAME"
          fi
        fi
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "skip_release=false" >> $GITHUB_OUTPUT
        
    - name: Create release
      if: steps.release_tag.outputs.skip_release != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_tag.outputs.tag_name }}
        name: InfoView ${{ steps.release_tag.outputs.tag_name }}
        files: |
          InfoView-source.zip
          code/compiled/firmware.bin
        body: |
          ## InfoView ${{ steps.release_tag.outputs.tag_name }}
          
          Compiled firmware release for InfoView ESP32-C3 Smart Display.
          
          ### Release Contents
          
          - **firmware.bin**: Pre-compiled binary for ESP32-C3 device
          - **InfoView-source.zip**: Complete source code archive
          
          ### Installation Instructions
          
          **Method 1: Using Arduino CLI**
          
          ```bash
          arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32c3:PartitionScheme=default code.ino
          ```
          
          **Method 2: Using esptool (direct binary flash)**
          
          ```bash
          esptool.py --chip esp32c3 --port /dev/ttyACM0 write_flash 0x10000 firmware.bin
          ```
          
          ### Hardware Configuration
          
          - ESP32-C3 Super Mini development board
          - 0.96" OLED display module (SSD1306, I2C interface)
          - Pin connections: SDA=GPIO 9, SCL=GPIO 8
          
          ### Software Requirements
          
          - Chronos mobile application (Android)
          - Bluetooth Low Energy support
          
          ### Documentation
          
          Complete installation and usage instructions are available in README.md.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

